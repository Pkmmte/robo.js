"use strict";(self.webpackChunkrobo_js_docs=self.webpackChunkrobo_js_docs||[]).push([[2768],{6655:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>h,contentTitle:()=>d,default:()=>x,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var t=r(4848),i=r(8453);r(6540);const o=e=>{const{from:s,to:r}=e;return(0,t.jsxs)("div",{className:"beforeAfter",children:[(0,t.jsx)("p",{className:"beforeAfterContent",children:s}),(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:16,height:16,className:"beforeAfterArrow",children:[(0,t.jsx)("title",{children:"arrow-down-bold"}),(0,t.jsx)("path",{d:"M9,4H15V12H19.84L12,19.84L4.16,12H9V4Z"})]}),(0,t.jsx)("p",{className:"beforeAfterContent",children:r})]})};var n=r(5646),c=r(9733);const a={description:"Learn how to make external network requests in your Discord Activity in a way compatible with the Discord Proxy.",image:"https://preview.robojs.dev?path=/discord-activities/proxy"},d="\ud83d\udee1\ufe0f Discord Proxy",l={id:"discord-activities/proxy",title:"\ud83d\udee1\ufe0f Discord Proxy",description:"Learn how to make external network requests in your Discord Activity in a way compatible with the Discord Proxy.",source:"@site/docs/discord-activities/proxy.mdx",sourceDirName:"discord-activities",slug:"/discord-activities/proxy",permalink:"/discord-activities/proxy",draft:!1,unlisted:!1,editUrl:"https://github.com/Wave-Play/robo.js/edit/main/docs/docs/discord-activities/proxy.mdx",tags:[],version:"current",lastUpdatedBy:"Pkmmte Xeleon",lastUpdatedAt:1720235282e3,frontMatter:{description:"Learn how to make external network requests in your Discord Activity in a way compatible with the Discord Proxy.",image:"https://preview.robojs.dev?path=/discord-activities/proxy"},sidebar:"tutorialSidebar",previous:{title:"\u2728 Getting Started",permalink:"/discord-activities/getting-started"},next:{title:"\u2694\ufe0f Multiplayer",permalink:"/discord-activities/multiplayer"}},h={},p=[{value:"Content Security Policy (CSP)",id:"content-security-policy-csp",level:2},{value:"Fetching External Resources",id:"fetching-external-resources",level:2},{value:"URL Mapping",id:"url-mapping",level:3},{value:"URL Patching",id:"url-patching",level:3},{value:"Proxying Requests",id:"proxying-requests",level:3},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Network Limitations",id:"network-limitations",level:2},{value:"Additional Resources",id:"additional-resources",level:2}];function u(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"\ufe0f-discord-proxy",children:"\ud83d\udee1\ufe0f Discord Proxy"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"./client",children:"Client"})})," network requests made by your ",(0,t.jsx)(s.strong,{children:"Discord Activity"}),' are "sandboxed" through ',(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://discord.com/developers/docs/activities/development-guides#activity-proxy-considerations",children:"Discord's Proxy"})}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["That means you cannot directly make network requests to ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"#external-resources",children:"external URLs"})})," from it for security reasons. You may have seen this if you've tried using iframes. There are also ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"#network-limitations",children:"limitations"})})," to what network protocols you can use."]}),"\n",(0,t.jsx)(s.h2,{id:"content-security-policy-csp",children:"Content Security Policy (CSP)"}),"\n",(0,t.jsxs)(s.p,{children:["Ever tried to load a URL from an external resource and got a ",(0,t.jsx)(s.code,{children:"blocked:csp"})," error? That's the ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," doing its job."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP",children:"Content Security Policy (CSP)"})})," is a security feature that helps prevent ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://owasp.org/www-community/attacks/xss/",children:"cross-site scripting (XSS)"})})," attacks. It restricts what can load, such as scripts, styles, and images. ",(0,t.jsx)(s.strong,{children:"Discord"})," trusts only you ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://discord.com/developers/docs/activities/development-guides#exceptions",children:"and itself"})}),". It will throw ",(0,t.jsx)(s.strong,{children:"CSP"})," errors at everyone else."]}),"\n",(0,t.jsx)(s.p,{children:"It may be a pain, but it's for your own good."}),"\n",(0,t.jsx)(s.h2,{id:"fetching-external-resources",children:"Fetching External Resources"}),"\n",(0,t.jsxs)(s.p,{children:["You can friend the ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," by using ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"#url-mapping",children:"URL Mappings"})}),", ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://github.com/discord/embedded-app-sdk/blob/main/patch-url-mappings.md",children:"patching URLs"})}),", or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"#proxying-requests",children:"proxying requests"})}),"."]}),"\n",(0,t.jsx)(c.Q,{children:(0,t.jsx)(n.Z,{href:"https://discord.com/developers/applications",title:"\ud83d\udd17 Discord Developer Portal",description:"Find it under your app's URL Mappings."})}),"\n",(0,t.jsx)(s.h3,{id:"url-mapping",children:"URL Mapping"}),"\n",(0,t.jsxs)(s.p,{children:["Mapping URLs is a way to tell the ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," to allow certain external resources. You can map a URL to a specific path in the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://discord.com/developers/applications",children:"Discord Developer Portal"})}),". This is the recommended way to allow external resources you need in your ",(0,t.jsx)(s.strong,{children:"Discord Activity"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["Let's say you need to load something from ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://github.com",children:"GitHub"})}),". You can map it to a path like ",(0,t.jsx)(s.code,{children:"/github"})," and ",(0,t.jsx)(s.code,{children:"/assets"}),"."]}),"\n",(0,t.jsx)(o,{from:"/github",to:"https://github.com"}),"\n",(0,t.jsx)(o,{from:"/assets",to:"https://raw.githubusercontent.com/Wave-Play/robo.js/main"}),"\n",(0,t.jsx)(s.p,{children:"This configuration maps URLs you can use in your activity like so:"}),"\n",(0,t.jsx)(o,{from:"/github/Wave-Play/robo.js",to:"https://github.com/Wave-Play/robo.js"}),"\n",(0,t.jsx)(o,{from:"/assets/README.md",to:"https://raw.githubusercontent.com/Wave-Play/robo.js/main/README.md"}),"\n",(0,t.jsx)("p",{}),"\n",(0,t.jsxs)(s.p,{children:["And voila, you can now load those URLs in your ",(0,t.jsx)(s.strong,{children:"Discord Activity"})," using the mapped paths."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-HTML",children:'<iframe src="/assets/README.md"></iframe>\n'})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",children:"fetch('/assets/docs/static/img/logo.png')\n"})}),"\n",(0,t.jsxs)(s.p,{children:["You can reference it as a path or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://discord.com/developers/docs/activities/development-guides#construct-a-full-url",children:"construct a full URL"})}),"."]}),"\n",(0,t.jsx)(s.admonition,{title:"Don't actually use GitHub as a CDN",type:"tip",children:(0,t.jsxs)(s.p,{children:["GitHub is not a CDN. Connect ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://roboplay.dev",children:"your host"})})," to a CDN like ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://www.cloudflare.com",children:"Cloudflare"})})," or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://bunny.net/",children:"Bunny.net"})})," for your assets."]})}),"\n",(0,t.jsx)(s.h3,{id:"url-patching",children:"URL Patching"}),"\n",(0,t.jsxs)(s.p,{children:["Mapping is great if you have control over the paths used, ",(0,t.jsx)(s.em,{children:"but what if you don't?"})," You know, like when using third-party libraries with hardcoded URLs. You can use the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://github.com/discord/embedded-app-sdk/",children:"Embedded App SDK"})})," for that!"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",children:"import { patchUrlMappings } from '@discord/embedded-app-sdk'\n\npatchUrlMappings([{ prefix: '/foo', target: 'foo.com' }])\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Alternatively, you can use a post-install utility like ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/patch-package",children:"patch-package"})})," or fork the library to use mapped URLs."]}),"\n",(0,t.jsx)(s.h3,{id:"proxying-requests",children:"Proxying Requests"}),"\n",(0,t.jsxs)(s.p,{children:["As a last resort, you can proxy requests through your ",(0,t.jsx)(s.strong,{children:"Web Server"}),". This is useful when you need to make requests to a specific port or handle requests that the ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," can't, but it's not always the best solution."]}),"\n",(0,t.jsxs)(s.p,{children:["Creating your own proxy is easy. Just create a file in ",(0,t.jsx)(s.code,{children:"/src/api"})," called ",(0,t.jsx)(s.code,{children:"proxy.js"})," with the following code:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",children:"export default async (request) => {\n\treturn fetch(request.query.url)\n}\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Modify as you see fit to validate requests. You can use it like so inside your ",(0,t.jsx)(s.strong,{children:"Activity Client"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-jsx",children:"<Player url={'/api/proxy?url=' + ExternalUrl} />\n"})}),"\n",(0,t.jsxs)(s.p,{children:["This code basically has your ",(0,t.jsx)(s.strong,{children:"Web Server"})," to fetch the data and send it back to your ",(0,t.jsx)(s.strong,{children:"Activity Client"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["While this method is effective for bypassing ",(0,t.jsx)(s.strong,{children:"CSP"})," restrictions, it does introduce additional latency because your server has to fetch the resource before serving it back to the activity. This may impact the performance of your activity, especially for large files or high traffic, so make sure your ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://docs.roboplay.dev/discord-activities/hosting",children:"Hosting Service"})})," can handle it."]}),"\n",(0,t.jsxs)(s.p,{children:["Be aware of potential security risks when using a proxy server, such as ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html",children:"URL Injections"})})," and ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_(SSRF)",children:"SSRF (Server-Side Request Forgery)"})})," attacks. Always use Discord's ",(0,t.jsx)(s.strong,{children:"URL Mapping"})," whenever possible."]}),"\n",(0,t.jsx)(s.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," hides the user's IP address and blocks URLs from known ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://www.youtube.com/watch?v=dQw4w9WgXcQ",children:"malicious endpoints"})}),". This ensures the safety of the user's data and privacy. However, it also means that you need to be careful when handling external resources."]}),"\n",(0,t.jsxs)(s.p,{children:["Don't trust info coming from the ",(0,t.jsx)(s.strong,{children:"Embedded App SDK"})," as truth. There could be an impostor among us. Call the Discord API directly from your app's ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"./server",children:"Web Server"})})," with the ",(0,t.jsx)(s.strong,{children:"OAuth2"})," token you received during ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"./auth",children:"Authentication"})})," if you need information that's not sus."]}),"\n",(0,t.jsx)(s.admonition,{title:"Sanitize Your Inputs",type:"warning",children:(0,t.jsx)(s.p,{children:"Always sanitize user inputs such as usernames and channel names. You never know what might try to sneak in."})}),"\n",(0,t.jsx)(s.h2,{id:"network-limitations",children:"Network Limitations"}),"\n",(0,t.jsxs)(s.p,{children:["Want to use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://webrtc.org/",children:"WebRTC"})})," or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://w3c.github.io/webrtc-quic/",children:"WebTransport"})}),"? Sorry, you can't. ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://discord.com/developers/docs/activities/development-guides#activity-proxy-considerations",children:"For now"})}),", at least."]}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.strong,{children:"Discord Proxy"})," does ",(0,t.jsx)(s.em,{children:"not"})," support the following:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developers.cloudflare.com/fundamentals/reference/network-ports/#network-ports-compatible-with-cloudflares-proxy",children:"Some iframe ports"})})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developers.cloudflare.com/workers/platform/known-issues/#custom-ports",children:"URL Mapping external ports"})})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://webrtc.org",children:"WebRTC"})})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://web.dev/webtransport",children:"WebTransport"})})}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["You'll be fine if you stick to ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/WebSocket",children:"WebSockets"})})," or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Glossary/HTTPS",children:"HTTPS"})}),", as well as some protocols built on them like ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/Media/Audio_and_video_delivery/Setting_up_adaptive_streaming_media_sources#mpeg-dash_encoding",children:"DASH"})})," or ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/Media/Audio_and_video_delivery/Setting_up_adaptive_streaming_media_sources#hls_encoding",children:"HLS"})})," for streaming."]}),"\n",(0,t.jsxs)(s.p,{children:["Need to make a request to a specific port? Have your ",(0,t.jsx)(s.strong,{children:"Web Server"})," handle it by ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.a,{href:"#proxying-requests",children:"proxying the request"})}),". That won't always work on iframes, though. You may need to virtualize the source and livestream it from your server but that has its own limitations."]}),"\n",(0,t.jsx)(s.h2,{id:"additional-resources",children:"Additional Resources"}),"\n",(0,t.jsxs)(c.Q,{children:[(0,t.jsx)(n.Z,{href:"https://discord.com/developers/docs/activities/development-guides#activity-proxy-considerations",title:"\ud83d\udd17 Discord Developer Docs",description:"Learn more about the Discord Proxy."}),(0,t.jsx)(n.Z,{href:"https://dev.to/waveplay/resolve-content-security-policy-csp-issues-in-your-discord-activity-using-a-nodejs-proxy-2634",title:"\ud83d\udcda Resolve CSP Issues with a Proxy",description:"A guide on how to set up a proxy to bypass CSP issues."})]})]})}function x(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},5646:(e,s,r)=>{r.d(s,{Z:()=>n});r(6540);var t=r(8774),i=r(1107),o=r(4848);const n=e=>{const{description:s,href:r,title:n}=e;return(0,o.jsx)(t.A,{className:"col col--6 nodecor margin-bottom--lg",to:r,children:(0,o.jsxs)("div",{className:"card padding--lg cardContent",children:[(0,o.jsx)(i.A,{as:"h4",className:"text--truncate cardTitle",children:n}),(0,o.jsx)("p",{className:"text--truncate cardDescription",children:s})]})})}},9733:(e,s,r)=>{r.d(s,{Q:()=>i});r(6540);var t=r(4848);const i=e=>{const{children:s}=e;return(0,t.jsx)("div",{className:"row cardContainer",children:s})}},8453:(e,s,r)=>{r.d(s,{R:()=>n,x:()=>c});var t=r(6540);const i={},o=t.createContext(i);function n(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:n(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);